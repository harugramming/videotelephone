<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.webrtc.ecl.ntt.com/skyway-4.4.1.js"></script>
  <link href="https://use.fontawesome.com/releases/v5.6.1/css/all.css" rel="stylesheet">
  <link rel="stylesheet" href="css/reset.css">
  <link rel="stylesheet" href="css/main.css">

  <title>通話アプリ</title>
</head>
<body>
  <header>
    <div id="title_container">
      <div id="title">通話アプリ</div>
    </div>
    <div id="control_container">
      <div id="icon-container">
        <i class="fas fa-microphone"></i>
        <!-- <i class="fas fa-microphone-slash"></i> -->
      </div>
      <div id="icon-container">
        <i class="fas fa-video"></i>
        <!-- <i class="fas fa-video-slash"></i> -->
      </div>
      <div id="icon-container">
        <i class="fas fa-volume-up"></i>
        <!-- <i class="fas fa-volume-mute"></i> -->
      </div>
    </div>
    <div>
      あなたの番号：<p id="my-id"></p>
    </div>
  </header>
  <video id="my-video" width="400px" autoplay muted playsinline></video>
  
  <input id="their-id"></input>
  <button id="make-call">発信</button>
  <video id="their-video" width="400px" autoplay playsinline></video>
  
  <div class="toggle-mute">
    <button id="js-toggle-camera">Toggle Camera</button>
    <span id="camera-status"></span>
    <br>
  
    <button id="js-toggle-microphone">Toggle Microphone</button>
    <span id="microphone-status"></span>
    <br>
  </div>
</body>
</html>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>

  const toggleCamera = document.getElementById('js-toggle-camera');
  const toggleMicrophone = document.getElementById('js-toggle-microphone');
  const cameraStatus = document.getElementById('camera-status');
  const microphoneStatus = document.getElementById('microphone-status');

  toggleCamera.addEventListener('click', () => {
    const videoTracks = localStream.getVideoTracks()[0];
    videoTracks.enabled = !videoTracks.enabled;
    cameraStatus.textContent = `カメラ${videoTracks.enabled ? 'ON' : 'OFF'}`;
  });

  toggleMicrophone.addEventListener('click', () => {
    const audioTracks = localStream.getAudioTracks()[0];
    audioTracks.enabled = !audioTracks.enabled;
    microphoneStatus.textContent = `マイク${audioTracks.enabled ? 'ON' : 'OFF'}`;
  });

  let localStream;

  //Peer作成
    const peer = new Peer({
    key: '11eaef3c-0969-41bf-9aa0-a489153871df',
    debug: 3
  });
  peer.on('open', () => {
    document.getElementById('my-id').textContent = peer.id;
  });

  // カメラ映像取得
  navigator.mediaDevices.getUserMedia({video: true, audio: true})
    .then( stream => {
    // 成功時にvideo要素にカメラ映像をセットし、再生
    const videoElm = document.getElementById('my-video');
    videoElm.srcObject = stream;
    videoElm.play();
    // 着信時に相手にカメラ映像を返せるように、グローバル変数に保存しておく
    localStream = stream;
  }).catch( error => {
    // 失敗時にはエラーログを出力
    console.error('mediaDevice.getUserMedia() error:', error);
    return;
  });


  // 発信処理
document.getElementById('make-call').onclick = () => {
  const theirID = document.getElementById('their-id').value;
  const mediaConnection = peer.call(theirID, localStream);
  setEventListener(mediaConnection);
};

// イベントリスナを設置する関数
const setEventListener = mediaConnection => {
  mediaConnection.on('stream', stream => {
    // video要素にカメラ映像をセットして再生
    const videoElm = document.getElementById('their-video')
    videoElm.srcObject = stream;
    videoElm.play();
  });
}

//着信処理
peer.on('call', mediaConnection => {
  mediaConnection.answer(localStream);
  setEventListener(mediaConnection);
});

</script>